<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Period Tracker ‚Äì Carnage Magnet</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #16161a;
    --primary: #e63946;
    --accent: #ff6b6b;
    --text: #f1f0ee;
    --muted: #6b6b7a;
    --border: #2a2a35;
    --glow: rgba(230,57,70,0.25);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 50% 50%, rgba(230,57,70,0.06) 0%, transparent 70%);
    pointer-events: none;
  }

  /* TOP BAR */
  #top-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 28px;
    z-index: 10;
  }

  #clock {
    font-family: 'DM Mono', monospace;
    font-size: 1.1rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    color: var(--text);
    opacity: 0.85;
  }

  #settings-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--muted);
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  #settings-btn:hover { border-color: var(--primary); color: var(--primary); }
  #settings-btn svg { width: 20px; height: 20px; }

  /* MAIN */
  #main {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 28px;
  }

  #period-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 0.3em;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* CIRCLE */
  #ring-wrapper {
    position: relative;
    width: 300px;
    height: 300px;
  }

  #ring-svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
    filter: drop-shadow(0 0 18px var(--glow));
  }

  #ring-bg {
    fill: none;
    stroke: var(--border);
    stroke-width: 22;
  }

  #ring-progress {
    fill: none;
    stroke: var(--primary);
    stroke-width: 22;
    stroke-linecap: round;
    transition: stroke-dashoffset 1s linear, stroke 0.4s;
  }

  #ring-content {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  #status-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.4rem;
    letter-spacing: 0.1em;
    color: var(--primary);
    line-height: 1;
    transition: color 0.4s;
  }

  #countdown {
    font-family: 'DM Mono', monospace;
    font-size: 1.3rem;
    font-weight: 500;
    color: var(--text);
    letter-spacing: 0.05em;
  }

  #next-label {
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  /* MESSAGE BANNER */
  #admin-message {
    max-width: 340px;
    text-align: center;
    font-size: 0.78rem;
    color: var(--accent);
    background: rgba(230,57,70,0.08);
    border: 1px solid rgba(230,57,70,0.2);
    border-radius: 10px;
    padding: 10px 18px;
    letter-spacing: 0.04em;
    display: none;
  }

  /* SCHEDULE INFO */
  #schedule-info {
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-align: center;
  }

  /* ---- MODALS ---- */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 32px;
    width: 340px;
    max-width: 95vw;
    position: relative;
  }

  .modal h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 0.15em;
    margin-bottom: 24px;
    color: var(--primary);
  }

  .modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
  }
  .modal-close:hover { color: var(--text); }

  .form-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 18px;
  }

  .form-row label {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .form-row input[type="color"] {
    width: 100%;
    height: 42px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    cursor: pointer;
    padding: 2px 4px;
  }

  .btn {
    width: 100%;
    padding: 12px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    letter-spacing: 0.06em;
    transition: opacity 0.2s;
  }
  .btn:hover { opacity: 0.85; }
  .btn.secondary {
    background: var(--border);
    color: var(--text);
    margin-top: 10px;
  }

  /* Admin */
  .admin-section {
    margin-bottom: 18px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 18px;
  }

  .admin-section:last-child { border-bottom: none; }

  .admin-section h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    color: var(--accent);
    letter-spacing: 0.15em;
    margin-bottom: 10px;
  }

  textarea, input[type="text"], input[type="date"] {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    padding: 10px 12px;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
  }
  textarea:focus, input[type="text"]:focus, input[type="date"]:focus {
    border-color: var(--primary);
  }

  .date-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }

  .date-chip {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 10px;
    font-size: 0.7rem;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .date-chip span.remove {
    color: var(--primary);
    cursor: pointer;
    font-weight: bold;
  }

  .date-input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .date-input-row input { flex: 1; }
  .date-input-row button {
    background: var(--primary);
    border: none;
    border-radius: 8px;
    color: white;
    padding: 0 14px;
    cursor: pointer;
    font-size: 1rem;
  }

  /* Admin login */
  #admin-login-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  #admin-pin-display {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
  }

  .pin-dot {
    width: 14px; height: 14px;
    border-radius: 50%;
    border: 2px solid var(--muted);
    transition: background 0.2s, border-color 0.2s;
  }
  .pin-dot.filled { background: var(--primary); border-color: var(--primary); }

  /* Supabase notice */
  #supabase-config {
    margin-top: 18px;
    padding: 12px;
    background: rgba(230,57,70,0.05);
    border: 1px dashed var(--primary);
    border-radius: 8px;
    font-size: 0.68rem;
    color: var(--muted);
    text-align: center;
    display: none;
  }

  .admin-modal { width: 400px; max-height: 85vh; overflow-y: auto; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="top-bar">
  <div id="clock">--:--:-- --</div>
  <button id="settings-btn" title="Settings">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </button>
</div>

<!-- MAIN -->
<div id="main">
  <div id="period-label">Carnage Magnet</div>
  <div id="ring-wrapper">
    <svg id="ring-svg" viewBox="0 0 300 300">
      <circle id="ring-bg" cx="150" cy="150" r="128"/>
      <circle id="ring-progress" cx="150" cy="150" r="128"/>
    </svg>
    <div id="ring-content">
      <div id="status-label">‚Äì</div>
      <div id="countdown">--:--</div>
      <div id="next-label"></div>
    </div>
  </div>
  <div id="admin-message"></div>
  <div id="schedule-info"></div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <h2>Settings</h2>
    <button class="modal-close" id="settings-close">‚úï</button>
    <div class="form-row">
      <label>Background Color</label>
      <input type="color" id="color-bg" value="#0d0d0f">
    </div>
    <div class="form-row">
      <label>Primary / Accent Color</label>
      <input type="color" id="color-primary" value="#e63946">
    </div>
    <button class="btn" id="save-settings">Apply Colors</button>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal-overlay" id="admin-login-modal">
  <div class="modal">
    <h2>Admin Access</h2>
    <button class="modal-close" id="admin-login-close">‚úï</button>
    <p style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;letter-spacing:0.05em;">Enter your 4-digit PIN</p>
    <div id="admin-pin-display">
      <div class="pin-dot" id="dot-0"></div>
      <div class="pin-dot" id="dot-1"></div>
      <div class="pin-dot" id="dot-2"></div>
      <div class="pin-dot" id="dot-3"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:16px;">
      <button class="btn secondary" onclick="pinPress('1')">1</button>
      <button class="btn secondary" onclick="pinPress('2')">2</button>
      <button class="btn secondary" onclick="pinPress('3')">3</button>
      <button class="btn secondary" onclick="pinPress('4')">4</button>
      <button class="btn secondary" onclick="pinPress('5')">5</button>
      <button class="btn secondary" onclick="pinPress('6')">6</button>
      <button class="btn secondary" onclick="pinPress('7')">7</button>
      <button class="btn secondary" onclick="pinPress('8')">8</button>
      <button class="btn secondary" onclick="pinPress('9')">9</button>
      <button class="btn secondary" onclick="pinClear()" style="grid-column:1">C</button>
      <button class="btn secondary" onclick="pinPress('0')">0</button>
      <button class="btn" onclick="pinSubmit()" style="grid-column:3">‚Üí</button>
    </div>
    <p id="pin-error" style="font-size:0.7rem;color:var(--primary);text-align:center;margin-top:10px;display:none;">Incorrect PIN</p>
  </div>
</div>

<!-- ADMIN PANEL MODAL -->
<div class="modal-overlay" id="admin-modal">
  <div class="modal admin-modal">
    <h2>Admin Panel</h2>
    <button class="modal-close" id="admin-close">‚úï</button>

    <div class="admin-section">
      <h3>üì¢ Post Message</h3>
      <textarea id="admin-msg-input" rows="3" placeholder="Message visible to all users..."></textarea>
      <button class="btn" style="margin-top:10px" onclick="saveMessage()">Post Message</button>
      <button class="btn secondary" onclick="clearMessage()">Clear Message</button>
    </div>

    <div class="admin-section">
      <h3>‚è∞ 2-Hour Delay Dates</h3>
      <div class="date-input-row">
        <input type="date" id="delay-date-input">
        <button onclick="addDate('delay')">+</button>
      </div>
      <div class="date-list" id="delay-date-list"></div>
    </div>

    <div class="admin-section">
      <h3>üö´ No School Dates</h3>
      <div class="date-input-row">
        <input type="date" id="closed-date-input">
        <button onclick="addDate('closed')">+</button>
      </div>
      <div class="date-list" id="closed-date-list"></div>
    </div>

    <button class="btn" onclick="saveAdminData()">Save All Changes</button>

    <div id="supabase-config">
      ‚ö†Ô∏è Supabase not configured. Set SUPABASE_URL and SUPABASE_ANON_KEY in the script below to enable cloud sync.
    </div>
  </div>
</div>

<script>
// ============================================================
// SUPABASE CONFIG ‚Äî replace with your credentials
// ============================================================
const SUPABASE_URL = '';
const SUPABASE_ANON_KEY = '';
const ADMIN_PIN = '1234'; // Change this PIN

// ============================================================
// SCHEDULE DATA
// ============================================================
const NORMAL_SCHEDULE = [
  { name: 'Arrival / Homeroom', start: [7,0],  end: [7,30]  },
  { name: 'Period 1',           start: [7,35],  end: [8,22]  },
  { name: 'Period 2',           start: [8,25],  end: [9,12]  },
  { name: 'Period 3',           start: [9,15],  end: [10,2]  },
  { name: 'Period 4',           start: [10,5],  end: [10,52] },
  { name: 'Period 5',           start: [10,55], end: [11,42] },
  { name: 'Period 6',           start: [11,45], end: [12,32] },
  { name: 'Period 7',           start: [12,35], end: [13,22] },
  { name: 'Period 8',           start: [13,25], end: [14,20] },
];

const DELAY_SCHEDULE = [
  { name: 'Arrival / Homeroom', start: [9,0],  end: [9,30]  },
  { name: 'Period 1',           start: [9,35],  end: [10,8]  },
  { name: 'Period 2',           start: [10,11], end: [10,44] },
  { name: 'Period 3',           start: [10,47], end: [11,20] },
  { name: 'Period 4',           start: [11,23], end: [11,56] },
  { name: 'Period 5',           start: [11,59], end: [12,32] },
  { name: 'Period 6',           start: [12,35], end: [13,8]  },
  { name: 'Period 7',           start: [13,11], end: [13,44] },
  { name: 'Period 8',           start: [13,47], end: [14,20] },
];

// ============================================================
// STATE
// ============================================================
let adminData = {
  message: '',
  delayDates: [],
  closedDates: []
};

let colors = {
  bg: '#0d0d0f',
  primary: '#e63946'
};

let zeroCount = 0;
let zeroTimer = null;
let pinBuffer = '';

// ============================================================
// SUPABASE HELPERS
// ============================================================
async function sbFetch(path, opts = {}) {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
  const res = await fetch(SUPABASE_URL + path, {
    ...opts,
    headers: {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal',
      ...(opts.headers || {})
    }
  });
  if (res.status === 204) return {};
  try { return await res.json(); } catch { return null; }
}

async function loadFromSupabase() {
  if (!SUPABASE_URL) {
    // fallback to localStorage
    const saved = localStorage.getItem('period_tracker_admin');
    if (saved) adminData = JSON.parse(saved);
    const savedColors = localStorage.getItem('period_tracker_colors');
    if (savedColors) colors = JSON.parse(savedColors);
    return;
  }
  // Load settings row (id=1)
  const rows = await sbFetch('/rest/v1/tracker_settings?id=eq.1&select=*');
  if (rows && rows.length > 0) {
    const row = rows[0];
    adminData = {
      message: row.message || '',
      delayDates: row.delay_dates || [],
      closedDates: row.closed_dates || []
    };
    if (row.color_bg) colors.bg = row.color_bg;
    if (row.color_primary) colors.primary = row.color_primary;
  }
}

async function saveToSupabase() {
  if (!SUPABASE_URL) {
    localStorage.setItem('period_tracker_admin', JSON.stringify(adminData));
    localStorage.setItem('period_tracker_colors', JSON.stringify(colors));
    return;
  }
  const payload = {
    id: 1,
    message: adminData.message,
    delay_dates: adminData.delayDates,
    closed_dates: adminData.closedDates,
    color_bg: colors.bg,
    color_primary: colors.primary
  };
  await sbFetch('/rest/v1/tracker_settings', {
    method: 'POST',
    headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
    body: JSON.stringify(payload)
  });
}

// ============================================================
// EST TIME HELPER
// ============================================================
function getEST() {
  return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
}

function toMins(h, m) { return h * 60 + m; }

function padTwo(n) { return String(n).padStart(2, '0'); }

function formatTime(d) {
  let h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return `${padTwo(h)}:${padTwo(m)}:${padTwo(s)} ${ampm}`;
}

function formatDate(d) {
  return `${d.getFullYear()}-${padTwo(d.getMonth()+1)}-${padTwo(d.getDate())}`;
}

// ============================================================
// SCHEDULE LOGIC
// ============================================================
function getDayStatus(now) {
  const dow = now.getDay(); // 0=Sun,6=Sat
  const dateStr = formatDate(now);

  if (adminData.closedDates.includes(dateStr) || dow === 0 || dow === 6) {
    return { type: 'noschool' };
  }

  const isDelay = adminData.delayDates.includes(dateStr);
  const schedule = isDelay ? DELAY_SCHEDULE : NORMAL_SCHEDULE;
  const curMins = toMins(now.getHours(), now.getMinutes()) * 60 + now.getSeconds();

  // School ends at end of period 8
  const schoolEnd = schedule[schedule.length - 1].end;
  const schoolEndSecs = toMins(...schoolEnd) * 60;

  for (let i = 0; i < schedule.length; i++) {
    const p = schedule[i];
    const pStart = toMins(...p.start) * 60;
    const pEnd   = toMins(...p.end) * 60;

    if (curMins >= pStart && curMins < pEnd) {
      return {
        type: 'period',
        name: p.name,
        remaining: pEnd - curMins,
        total: pEnd - pStart,
        progress: (curMins - pStart) / (pEnd - pStart),
        isDelay
      };
    }

    // Between periods
    if (i < schedule.length - 1) {
      const nextP = schedule[i+1];
      const nextStart = toMins(...nextP.start) * 60;
      if (curMins >= pEnd && curMins < nextStart) {
        return {
          type: 'passing',
          name: 'Passing',
          nextName: nextP.name,
          remaining: nextStart - curMins,
          total: nextStart - pEnd,
          progress: (curMins - pEnd) / (nextStart - pEnd),
          isDelay
        };
      }
    }
  }

  // Before school
  const firstStart = toMins(...schedule[0].start) * 60;
  if (curMins < firstStart) {
    return {
      type: 'before',
      remaining: firstStart - curMins,
      total: firstStart,
      progress: 0
    };
  }

  // After school
  return { type: 'free' };
}

// ============================================================
// UI UPDATE
// ============================================================
const CIRCUMFERENCE = 2 * Math.PI * 128;
document.getElementById('ring-progress').style.strokeDasharray = CIRCUMFERENCE;

function update() {
  const now = getEST();
  document.getElementById('clock').textContent = formatTime(now);

  const status = getDayStatus(now);
  const statusEl  = document.getElementById('status-label');
  const countEl   = document.getElementById('countdown');
  const nextEl    = document.getElementById('next-label');
  const schedEl   = document.getElementById('schedule-info');
  const ring      = document.getElementById('ring-progress');

  if (status.type === 'noschool') {
    statusEl.textContent  = 'No School';
    countEl.textContent   = '';
    nextEl.textContent    = '';
    schedEl.textContent   = 'Weekend or Holiday';
    ring.style.strokeDashoffset = CIRCUMFERENCE;
    setAccent(colors.primary, 0.3);
    return;
  }

  if (status.type === 'free') {
    statusEl.textContent  = 'Free';
    countEl.textContent   = '';
    nextEl.textContent    = 'School is out';
    schedEl.textContent   = '';
    ring.style.strokeDashoffset = CIRCUMFERENCE;
    setAccent(colors.primary, 0.5);
    return;
  }

  if (status.type === 'before') {
    statusEl.textContent = 'Before School';
    const m = Math.floor(status.remaining / 60);
    const s = status.remaining % 60;
    countEl.textContent = `${padTwo(m)}:${padTwo(s)}`;
    nextEl.textContent = 'until arrival';
    schedEl.textContent = status.isDelay ? '2-Hour Delay Schedule' : 'Normal Schedule';
    ring.style.strokeDashoffset = CIRCUMFERENCE;
    setAccent(colors.primary, 1);
    return;
  }

  const rem = status.remaining;
  const m = Math.floor(rem / 60);
  const s = rem % 60;

  if (status.type === 'period') {
    statusEl.textContent = status.name;
    countEl.textContent  = `${padTwo(m)}:${padTwo(s)}`;
    nextEl.textContent   = 'remaining';
  } else {
    statusEl.textContent = 'Passing';
    countEl.textContent  = `${padTwo(m)}:${padTwo(s)}`;
    nextEl.textContent   = `‚Üí ${status.nextName}`;
  }

  schedEl.textContent = status.isDelay ? '2-Hour Delay Schedule' : 'Normal Schedule';

  const offset = CIRCUMFERENCE * (1 - status.progress);
  ring.style.strokeDashoffset = offset;
  setAccent(colors.primary, 1);
}

function setAccent(color, opacity) {
  document.getElementById('ring-progress').style.stroke = color;
  document.getElementById('status-label').style.color = color;
}

// ============================================================
// COLORS
// ============================================================
function applyColors() {
  document.documentElement.style.setProperty('--bg', colors.bg);
  document.documentElement.style.setProperty('--surface', adjustBrightness(colors.bg, 10));
  document.documentElement.style.setProperty('--primary', colors.primary);
  document.documentElement.style.setProperty('--accent', colors.primary);
  document.documentElement.style.setProperty('--glow', hexToRgba(colors.primary, 0.25));
  document.documentElement.style.setProperty('--border', hexToRgba(colors.primary, 0.15));
}

function hexToRgba(hex, a) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

function adjustBrightness(hex, amount) {
  let r = parseInt(hex.slice(1,3),16) + amount;
  let g = parseInt(hex.slice(3,5),16) + amount;
  let b = parseInt(hex.slice(5,7),16) + amount;
  r = Math.min(255, Math.max(0, r));
  g = Math.min(255, Math.max(0, g));
  b = Math.min(255, Math.max(0, b));
  return `#${padTwo(r.toString(16))}${padTwo(g.toString(16))}${padTwo(b.toString(16))}`;
}

// ============================================================
// SETTINGS MODAL
// ============================================================
document.getElementById('settings-btn').onclick = () => {
  document.getElementById('color-bg').value = colors.bg;
  document.getElementById('color-primary').value = colors.primary;
  document.getElementById('settings-modal').classList.add('open');
};
document.getElementById('settings-close').onclick = () => {
  document.getElementById('settings-modal').classList.remove('open');
};
document.getElementById('save-settings').onclick = async () => {
  colors.bg = document.getElementById('color-bg').value;
  colors.primary = document.getElementById('color-primary').value;
  applyColors();
  await saveToSupabase();
  document.getElementById('settings-modal').classList.remove('open');
};

// ============================================================
// 5x ZERO = ADMIN
// ============================================================
document.addEventListener('keydown', (e) => {
  if (e.key === '0') {
    zeroCount++;
    clearTimeout(zeroTimer);
    zeroTimer = setTimeout(() => { zeroCount = 0; }, 2000);
    if (zeroCount >= 5) {
      zeroCount = 0;
      openAdminLogin();
    }
  }
});

// Also support mobile: tap "0" 5x via a hidden counter
let tapZeroEl = document.createElement('div');
tapZeroEl.style.cssText = 'position:fixed;bottom:0;left:0;width:60px;height:60px;z-index:5;opacity:0';
tapZeroEl.onclick = () => {
  zeroCount++;
  clearTimeout(zeroTimer);
  zeroTimer = setTimeout(() => { zeroCount = 0; }, 2000);
  if (zeroCount >= 5) {
    zeroCount = 0;
    openAdminLogin();
  }
};
document.body.appendChild(tapZeroEl);

function openAdminLogin() {
  pinBuffer = '';
  updatePinDots();
  document.getElementById('pin-error').style.display = 'none';
  document.getElementById('admin-login-modal').classList.add('open');
}

// ============================================================
// PIN
// ============================================================
function pinPress(d) {
  if (pinBuffer.length < 4) {
    pinBuffer += d;
    updatePinDots();
  }
}
function pinClear() { pinBuffer = ''; updatePinDots(); }
function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    document.getElementById('dot-' + i).classList.toggle('filled', i < pinBuffer.length);
  }
}
function pinSubmit() {
  if (pinBuffer === ADMIN_PIN) {
    document.getElementById('admin-login-modal').classList.remove('open');
    openAdminPanel();
  } else {
    document.getElementById('pin-error').style.display = 'block';
    pinBuffer = '';
    updatePinDots();
  }
}

document.getElementById('admin-login-close').onclick = () => {
  document.getElementById('admin-login-modal').classList.remove('open');
};

// ============================================================
// ADMIN PANEL
// ============================================================
function openAdminPanel() {
  document.getElementById('admin-msg-input').value = adminData.message;
  renderDateList('delay');
  renderDateList('closed');
  if (!SUPABASE_URL) {
    document.getElementById('supabase-config').style.display = 'block';
  }
  document.getElementById('admin-modal').classList.add('open');
}

document.getElementById('admin-close').onclick = () => {
  document.getElementById('admin-modal').classList.remove('open');
};

function renderDateList(type) {
  const listEl = document.getElementById(type + '-date-list');
  const dates = type === 'delay' ? adminData.delayDates : adminData.closedDates;
  listEl.innerHTML = dates.map(d =>
    `<div class="date-chip">${d} <span class="remove" onclick="removeDate('${type}','${d}')">√ó</span></div>`
  ).join('');
}

function addDate(type) {
  const input = document.getElementById(type + '-date-input');
  const val = input.value;
  if (!val) return;
  const arr = type === 'delay' ? adminData.delayDates : adminData.closedDates;
  if (!arr.includes(val)) arr.push(val);
  renderDateList(type);
  input.value = '';
}

function removeDate(type, date) {
  if (type === 'delay') {
    adminData.delayDates = adminData.delayDates.filter(d => d !== date);
  } else {
    adminData.closedDates = adminData.closedDates.filter(d => d !== date);
  }
  renderDateList(type);
}

async function saveMessage() {
  adminData.message = document.getElementById('admin-msg-input').value.trim();
  await saveToSupabase();
  updateMessageBanner();
}

async function clearMessage() {
  adminData.message = '';
  document.getElementById('admin-msg-input').value = '';
  await saveToSupabase();
  updateMessageBanner();
}

async function saveAdminData() {
  adminData.message = document.getElementById('admin-msg-input').value.trim();
  await saveToSupabase();
  updateMessageBanner();
  document.getElementById('admin-modal').classList.remove('open');
}

function updateMessageBanner() {
  const el = document.getElementById('admin-message');
  if (adminData.message) {
    el.textContent = adminData.message;
    el.style.display = 'block';
  } else {
    el.style.display = 'none';
  }
}

// ============================================================
// INIT
// ============================================================
async function init() {
  await loadFromSupabase();
  applyColors();
  updateMessageBanner();
  update();
  setInterval(update, 1000);
  // Reload admin data every 30s (in case someone else posted a message)
  setInterval(async () => {
    await loadFromSupabase();
    updateMessageBanner();
  }, 30000);
}

init();
</script>
</body>
</html>
